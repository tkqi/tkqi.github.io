---
title: 20231207
date: 2023-12-07 18:15:37
tags:
- problems
categories:
- others
---

### 异步方法事务锁问题

- 需要频繁对主从表进行插入
- 从表插入后子表未及时更新

#### 原因

>  两个几乎同时执行的异步方法其中一个对主表的更新会被另一个覆盖

#### 解决

使用悲观锁

- 2个相同的业务代码 同时执行时必须等待 第一个执行成功后执行
- 锁加载查询方法中`TranLock(DbLockType.Wait)`
- 主键查询一般是行锁，如果非主键可以会变成表锁
